#!/bin/bash
. "${STFW_HOME}/bin/lib/setenv"

plugin_dir=$(cd "$(dirname $0)/.."; pwd)
. "${plugin_dir}/lib/common"

template_file="${plugin_dir}/webhook/template.yml"
template_script_file="${plugin_dir}/webhook/template_scripts.yml"

tmp_scripts_status_file=$(plugin.process.scripts.get_scripts_status_filepath)
cat /dev/null >"${tmp_scripts_status_file}"

# startはスクリプト名のみ
for _cur_file in $(plugin.process.scripts.list_files "scripts"); do
  export script_name="${_cur_file}"
  export script_result="Pending"
  export script_start_time=
  export script_end_time=
  export script_processing_time=

  cat "${template_script_file}" | grep -v "^#" |
  while IFS= read -r _line; do
    eval "echo \"${_line}\""
  done >>"${tmp_scripts_status_file}"
done

cat "${template_file}" "${tmp_scripts_status_file}"
